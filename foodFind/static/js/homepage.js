var searchOpen = false


anime({
    targets: 'article',
    opacity: 1,
    duration: 1000,
    easing: 'cubicBezier(.5, .05, .1, .3)'
});
document.getElementById('searchInput').onfocus = function () {
    console.log("expand search")
    anime({
        targets: 'div#search',
        backgroundColor: '#FFF',
        duration: 500,
        width: '60%',
    });
    searchOpen = true
}
document.getElementById('searchInput').onblur = function () {
    console.log("shrink search")
    anime({
        targets: 'div#search',
        backgroundColor: '#FFF',
        duration: 500,
        width: '40%',
    });
    searchOpen = false
}
document.getElementById('searchInput').onkeydown = function (event) {
    if (event.key === 'Enter') {
        submitSearch()
    }
}

function doStars(stars) {
    console.log("do stars")
    var fullStars = Math.floor(stars);
    var halfStar = Math.round(stars - fullStars);
    var output = ""
    for (var i = 0; i < fullStars; i++) {
        output += '<i class="fill extra">star</i>';
    }
    if (halfStar) {
        output += ('<i class="fill extra">star_half</i>');
    }
    for (var i = 0; i < 5 - fullStars - halfStar; i++) {
        output += ('<i class="extra">star</i>');
    }
    return output
}

async function submitSearch() {
    //get custom filters and stuff
    const {Place} = await google.maps.importLibrary("places");

    var query = document.getElementById('searchInput').value.trim()
    const request = {
        textQuery: query,
        fields: ["displayName", "primaryTypeDisplayName", "location", "businessStatus", "editorialSummary", "photos", "priceLevel", "rating", "userRatingCount", "types"],
        includedType: "restaurant",
        locationBias: {lat: 33.74969690485657, lng: -84.39235565742148},
        isOpenNow: true,
        language: "en-US",
        maxResultCount: 8,
        minRating: 3.2,
        region: "us",
        useStrictTypeFiltering: false,
    };

    const {places} = await Place.searchByText(request);
    if (places.length) {
        console.log(places)
        document.getElementById('results').innerHTML = ""

        places.forEach(async (place) => {
            console.log(place.displayName)

            var editorial = place.editorialSummary
            if (!place.editorialSummary) {
                editorial = await fetch("/generateDescription?restaurantName=" + place.displayName + "&restaurantType=" + place.primaryTypeDisplayName).then(response => response.text())
            }

            var cardTemplate = `
<div class="padding" id="${place.id}">
        <article class="responsive large-padding center center-align pink1 large-round" style="opacity:0.3">
            <div class="grid">
                <div class="s6">
                    <img class="responsive medium-height" src="${place.photos[1].getURI()}" alt="" style="width:100%;height:100%;opacity:70%">
                    <div class="absolute top left right padding top-shadow white-text"><h5>${place.displayName}</h5>
                        <p>${place.primaryTypeDisplayName}</p></div>
                </div>
                <div class="s6">
                    <div class="padding middle">
                        <div class="grid">
                            <div class="s1 m3 l12">
                                <div class="middle-align">
                                
                                ${doStars(place.rating)}
                                    
                                </div>
                                
                                
                            </div>
                            <div class="s1 m4 l12">
                            <h5 class="left-align">${place.rating} stars
                                <br><h6 class="small-text italic gray left-align">${place.userRatingCount} ratings</h6></h5>
                                <h6 class="small-text left-align gray">${(!place.priceLevel || place.priceLevel.charAt(0) === "F" || place.priceLevel.charAt(0) === "I") ? "$" : (place.priceLevel.charAt(0) === "M") ? "$$" : "$$$"} Â· ${place.priceLevel ? place.priceLevel.toLowerCase() : "no price data"}</h6>
</div>
                            <hr>
                            <div class="s6 m12 l12">
                                <p class="left-align">${place.editorialSummary ? editorial : editorial + "<br><p class='italic small-text left-align'>Description generated by AI</p>"}</p>
                            </div>
                            <div class="s15 m12 l12">
                                <nav>
                                    <button class="round">View in Map</button>
                                    <button class="border round">Add to Favorites</button>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </article>
    </div>
`

            document.getElementById('results').innerHTML += cardTemplate
            anime({
                targets: 'article',
                opacity: 1,
                duration: 1000,
                easing: 'cubicBezier(.5, .05, .1, .3)'
            });

        });
    }
}