<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCtYu97MeZ3EBsEGiHCg6UYPg-6e0p0JrQ&libraries=places"></script>
    <script>
        let map;
        let service;
        let currentInfoWindow = null;
        let markers = [];
        let pagination = null; // To track pagination

        function initMap() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function (position) {
                        const userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };

                        map = new google.maps.Map(document.getElementById('map'), {
                            center: userLocation,
                            zoom: 15,
                        });

                        service = new google.maps.places.PlacesService(map);
                        performSearch(1000);

                        new google.maps.Marker({
                            position: userLocation,
                            map: map,
                            title: "You are here",
                            icon: {
                                url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                            }
                        });
                    },
                    function () {
                        handleLocationError(true, map.getCenter());
                    }
                );
            } else {
                handleLocationError(false, map.getCenter());
            }
        }

        function handleLocationError(browserHasGeolocation, pos) {
            alert(
                browserHasGeolocation
                    ? "Error: The Geolocation service failed."
                    : "Error: Your browser doesn't support geolocation."
            );
        }

        function performSearch(radius) {
            const userLocation = map.getCenter();
            const request = {
                location: userLocation,
                radius: radius,
                type: ['restaurant'],
                fields: ['place_id', 'name', 'vicinity', 'rating']
            };

            clearMarkers();

            service.nearbySearch(request, (results, status, pag) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    results.forEach(place => {
                        const marker = new google.maps.Marker({
                            map: map,
                            position: place.geometry.location,
                            title: place.name,
                        });

                        markers.push(marker);
                        getPlaceDetails(place.place_id, marker);
                    });
                    if (pag.hasNextPage) {
                        pagination = pag;
                        setTimeout(() => pagination.nextPage(), 100); // timeout to handle errors if any
                    } else {
                        pagination = null; // No more pages available
                    }
                    map.addListener('click', () => {
                        if (currentInfoWindow) {
                            currentInfoWindow.close();
                            currentInfoWindow = null;
                        }
                    });
                }
            });
        }
        function clearMarkers() {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
        }
        function getPlaceDetails(placeId, marker) {
            const request = {
                placeId: placeId,
                fields: ['name', 'vicinity', 'rating', 'place_id', 'user_ratings_total', 'editorial_summary', 'photos', 'international_phone_number', "website", "types"]
            };
            service.getDetails(request, (place, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    function getCuisineFromNameOrDescription(place) {
                        const keywords = /(fast food|american|chinese|italian|mexican|indian|japanese|korean|thai|mediterranean|snack)/i;

                        // Check in place name
                        if (keywords.test(place.name)) {
                            return place.name.match(keywords)[0];  // Return the matched cuisine type
                        }

                        // Check in editorial summary (description) if available
                        if (place.editorial_summary && keywords.test(place.editorial_summary.overview)) {
                            return place.editorial_summary.overview.match(keywords)[0];  // Return the matched cuisine type
                        }

                        return 'Cuisine type not available';  // Fallback if no match is found
                    }
                    let photoUrl = '';
                    if (place.photos && place.photos.length > 0) {
                        photoUrl = place.photos[0].getUrl({ maxWidth: 300, maxHeight: 300 });
                    }

                    const cuisineType = getCuisineFromNameOrDescription(place);
                    const phoneNumber = place.international_phone_number || 'No phone number available';
                    const website = place.website || 'No website available';
                    const description = place.editorial_summary ? place.editorial_summary.overview : 'No description available';

                    const infoWindowContent = `
                        <div>
                            {% if user.is_authenticated %}
                                ${photoUrl ? `<img src="${photoUrl}" alt="${place.name}" style="max-width: 80%; height: auto;">` : ''}
                                <h3>${place.name}</h3>
                                <p>${place.vicinity}</p>
                                <p>${cuisineType}</p>
                                <p>Rating: ${place.rating || 'No rating available'}</p>
                                <p>${place.user_ratings_total || 'No'} reviews</p>
                                <p><strong>Website:</strong> ${website}</p>
                                <p><strong>Phone Number:</strong> ${phoneNumber}</p>
                                <p>>${description}</p>
                                <button onclick="addToFavorites('${place.place_id}', '${place.name.replace(/'/g, "\\'")}', '${place.rating}', '${place.vicinity}')">Add to Favorites</button>
                                <button onclick="removeFromFavorites('${place.place_id}', '${place.name.replace(/'/g, "\\'")}')">Remove from Favorites</button>
                            {% else %}
                                ${photoUrl ? `<img src="${photoUrl}" alt="${place.name}" style="max-width: 80%; height: auto;">` : ''}
                                <h3>${place.name}</h3>
                                <p>${place.vicinity}</p>
                                <p>${cuisineType}</p>
                                <p>Rating: ${place.rating || 'No rating available'}</p>
                                <p>${place.user_ratings_total || 'No'} reviews</p>
                                <p><strong>Website:</strong> ${website}</p>
                                <p><strong>Phone Number:</strong> ${phoneNumber}</p>
                                <p>>${description}</p>
                            {% endif %}
                        </div>
                    `;

                    const infoWindow = new google.maps.InfoWindow({
                        content: infoWindowContent
                    });

                    marker.addListener('click', () => {
                        if (currentInfoWindow) {
                            currentInfoWindow.close();
                        }
                        infoWindow.open(map, marker);
                        currentInfoWindow = infoWindow;
                    });
                }
            });
        }

        function updateRadius() {
            const newRadius = document.getElementById('radius').value;
            if (newRadius) {
                performSearch(parseInt(newRadius) * 1000);
            }
        }

        function addToFavorites(place_id, name, rating, address) {
            console.log('Adding to favorites:', place_id, name, rating);

            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch('/users/addFavorites/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    'place_id': place_id,
                    'name': name,
                    'address': address,
                    'rating': rating,
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`${name} has been added to your favorites!`);
                    } else {
                        alert(`${name} is already in your favorites.`);
                    }
                })
                .catch(error => {
                    alert('An error occurred while adding to favorites. Please try again.');
                });
        }

        function removeFromFavorites(place_id, name) {
            console.log('Removing from favorites:', place_id);

            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch('/users/removeFavorites/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    'place_id': place_id
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`${name} has been removed from your favorites!`);
                    location.reload();
                } else if (data.message === 'Favorite not found.') {
                    alert(`${name} is not in your favorites.`);
                } else {
                    alert('An error occurred. Please try again.');
                }
            })
            .catch(error => {
                alert('An error occurred while removing from favorites. Please try again.');
            });
        }

    </script>

</head>
<body onload="initMap()">
<h1>Restaurants in Atlanta</h1>

<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<!-- Map container -->
<div id="map" style="height: 500px; width: 100%;"></div>

<!-- Input field for radius -->
<label for="radius">Radius (km):</label>
<input type="number" id="radius" name="radius" placeholder="Enter radius in km">
<button onclick="updateRadius()">Update Radius</button>

</body>
</html>
